apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: not-used
spec:
  values:
    proxyAddressForwarding: true
    metrics:
      enabled: false
      serviceMonitor:
        enabled: false
        namespace: "monitoring"
    postgresql:
      enabled: true
      auth:
        username: bn_keycloak
        database: bitnami_keycloak
        existingSecret: keycloak-postgresql-auth
    extraEnvVars:
    - name: PROXY_ADDRESS_FORWARDING
      value: "true"
    - name: KEYCLOAK_STATISTICS
      value: all
    service:
      type: ClusterIP
    ingress:
      enabled: true
      ingressClassName: "nginx"
      pathType: ImplementationSpecific
      apiVersion: ""
      hostname: auth.raelix.com
      path: "/"
      tls: true
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
    auth:
      adminUser: raelix
      existingSecret: keycloak-auth
    keycloakConfigCli:
      enabled: true
      # issue https://github.com/bitnami/charts/issues/14279
      command:
      - java
      - -jar
      - /opt/bitnami/keycloak-config-cli/keycloak-config-cli.jar
      configuration:
        realm.json: |
          {
            "realm": "master",
            "clientScopes": [
              {
                "name": "groups",
                "protocol": "openid-connect",
                "protocolMappers": [
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-group-membership-mapper",
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "userinfo.token.claim": "true"
                    }
                  }
                ]
              }
            ],
            "groups": [
              {
                "name": "oauth2-proxy"
              },
              {
                "name": "grafana-admin"
              },
              {
                "name": "grafana-dev"
              },
              {
                "name": "ArgoCDAdmins"
              },
              {
                "name": "ArgoCDViewers"
              },
              {
                "name": "admin"
              },
              {
                "name": "guest"
              }
            ],
            "clients": [
              {
                "clientId": "oauth2-proxy",
                "secret": "oauth2-client-secret",
                "enabled": true,
                "clientAuthenticatorType": "client-secret",
                "redirectUris": [
                  "https://oauth2-proxy.raelix.com/oauth2/callback"
                ],
                "defaultClientScopes": [
                  "email",
                  "groups",
                  "profile"
                ],
                "optionalClientScopes": [
                  "address",
                  "microprofile-jwt",
                  "offline_access",
                  "phone",
                  "roles",
                  "web-origins"
                ],
                "protocolMappers": [
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-group-membership-mapper",
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "userinfo.token.claim": "true"
                    }
                  }
                ]
              },
              {
                "clientId": "grafana",
                "secret": "grafana-client-secret",
                "enabled": true,
                "clientAuthenticatorType": "client-secret",
                "redirectUris": [
                  "https://grafana.raelix.com/login/generic_oauth"
                ],
                "defaultClientScopes": [
                  "email",
                  "groups",
                  "profile",
                  "roles",
                  "web-origins"
                ],
                "optionalClientScopes": [
                  "address",
                  "microprofile-jwt",
                  "offline_access",
                  "phone"
                ],
                "protocolMappers": [
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-group-membership-mapper",
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "userinfo.token.claim": "true"
                    }
                  }
                ]
              },
              {
                "clientId": "argocd",
                "secret": "argocd-client-secret",
                "enabled": true,
                "clientAuthenticatorType": "client-secret",
                "redirectUris": [
                  "https://argocd.raelix.com/auth/callback"
                ],
                "defaultClientScopes": [
                  "email",
                  "groups",
                  "profile",
                  "roles",
                  "web-origins"
                ],
                "optionalClientScopes": [
                  "address",
                  "microprofile-jwt",
                  "offline_access",
                  "phone"
                ],
                "protocolMappers": [
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-group-membership-mapper",
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "userinfo.token.claim": "true"
                    }
                  }
                ]
              },
              {
                "clientId": "rancher",
                "enabled": true,
                "clientAuthenticatorType": "client-secret",
                "secret": "rancher-client-secret",
                "redirectUris": [
                  "https://rancher.raelix.com/verify-auth"
                ],
                "defaultClientScopes": [
                  "email",
                  "groups",
                  "profile",
                  "roles",
                  "web-origins"
                ],
                "optionalClientScopes": [
                  "address",
                  "microprofile-jwt",
                  "offline_access",
                  "phone"
                ],
                "protocolMappers": [
                  {
                    "name": "groups",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-group-membership-mapper",
                    "config": {
                      "id.token.claim": "true",
                      "access.token.claim": "true",
                      "claim.name": "groups",
                      "userinfo.token.claim": "true"
                    }
                  },
                  {
                    "name": "Client Audience",
                    "protocol": "openid-connect",
                    "protocolMapper": "oidc-audience-mapper",
                    "consentRequired": false,
                    "config": {
                        "included.client.audience": "rancher",
                        "id.token.claim": "false",
                        "access.token.claim": "true"
                    }
                  }
                ]
              }
            ],
            "users": [
              {
                "username": "raelix",
                "email": "raelix@hotmail.it",
                "enabled": true,
                "firstName": "raelix",
                "lastName": "raelix",
                "emailVerified": true,
                "realmRoles": [
                  "admin",
                  "create-realm",
                  "offline_access",
                  "uma_authorization",
                  "default-roles-master"
                ],
                "groups": [
                  "grafana-admin",
                  "ArgoCDAdmins",
                  "oauth2-proxy",
                  "admin"
                ],
                "attributes": [
                  {
                    "locale": [
                      "it"
                    ]
                  }
                ]
              },
              {
                "username": "guest",
                "email": "guest@raelix.com",
                "enabled": true,
                "firstName": "guest",
                "lastName": "guest",
                "emailVerified": true,
                "groups": [
                  "guest"
                ],
                "credentials": [
                  {
                    "type": "password",
                    "userLabel": "initial",
                    "value": "guest"
                  }
                ],
                "attributes": [
                  {
                    "locale": [
                      "it"
                    ]
                  }
                ]
              }
            ]
          }